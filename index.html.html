<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM Director - Ultimate v3.0</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' }
                    }
                }
            }
        }
    </script>
    <!-- Iconos FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- SweetAlert2 (Alertas y Modales) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Chart.js (Gr√°ficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SortableJS (Arrastrar y Soltar) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; transition: background-color 0.3s; }
        
        /* Efecto Vidrio (Glassmorphism) */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass-panel {
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Scrollbar Personalizado */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        /* Estilos corporativos (B2B) */
        .is-corporate-card { border-left: 4px solid #3b82f6 !important; background: linear-gradient(to right, #eff6ff, white); }
        .dark .is-corporate-card { border-left: 4px solid #3b82f6 !important; background: linear-gradient(to right, #1e3a8a30, #111827); }

        /* Etiquetas de Curso (Colores Espec√≠ficos) */
        .tag-powerbi { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
        .tag-excel { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .tag-sql { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .tag-python { background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .tag-default { background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }

        .dark .tag-powerbi { background-color: #854d0e; color: #fef9c3; border-color: #a16207; }
        .dark .tag-excel { background-color: #14532d; color: #dcfce7; border-color: #166534; }
        .dark .tag-sql { background-color: #7f1d1d; color: #fee2e2; border-color: #991b1b; }
        .dark .tag-python { background-color: #1e3a8a; color: #dbeafe; border-color: #1e40af; }
        
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 min-h-screen">

    <!-- === VISTA LOGIN === -->
    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gradient-to-br from-gray-900 to-blue-900">
        <div class="glass-panel p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fa-solid fa-chart-line text-5xl text-brand-500 mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-800 dark:text-white">CRM Director</h2>
                <p class="text-gray-500 text-sm">Panel de Control v3.0</p>
            </div>
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-800 border-none ring-1 ring-gray-200 dark:ring-gray-700 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="admin@empresa.com" required>
                <input type="password" id="login-password" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-800 border-none ring-1 ring-gray-200 dark:ring-gray-700 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Contrase√±a" required>
                <button type="submit" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 rounded-lg transition shadow-lg">Entrar</button>
            </form>
        </div>
    </div>

    <!-- === VISTA DASHBOARD === -->
    <div id="dashboard-view" class="hidden min-h-screen flex flex-col">
        
        <!-- Navbar -->
        <nav class="glass-panel sticky top-0 z-40 border-b shadow-sm">
            <div class="max-w-full mx-auto px-4 lg:px-6">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-xl tracking-tight">Director<span class="text-brand-600">CRM</span></span>
                        <div class="h-6 w-px bg-gray-300 dark:bg-gray-700"></div>
                        <button id="theme-toggle" class="p-2 text-gray-500 hover:text-brand-600"><i class="fa-solid fa-moon dark:hidden"></i><i class="fa-solid fa-sun hidden dark:block text-yellow-400"></i></button>
                    </div>

                    <div class="flex items-center gap-3">
                        <button onclick="openTemplateConfig()" class="p-2 text-gray-500 hover:text-brand-600" title="Configurar Plantillas de Mensajes"><i class="fa-solid fa-gear text-lg"></i></button>
                        
                        <button id="notif-btn" class="relative p-2 text-gray-500 hover:text-brand-600">
                            <i class="fa-regular fa-bell text-xl"></i>
                            <span id="notif-badge" class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                        </button>
                        <!-- Dropdown Notificaciones -->
                        <div id="notif-dropdown" class="hidden absolute top-14 right-4 w-80 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-100 dark:border-gray-700 z-50 max-h-96 overflow-y-auto">
                            <div class="p-3 font-bold border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900">üîî Pendientes Urgentes</div>
                            <div id="notif-list"></div>
                        </div>

                        <div class="text-right hidden sm:block">
                            <p class="text-[10px] text-gray-400 uppercase font-bold">Usuario</p>
                            <p id="user-display" class="text-sm font-bold truncate max-w-[100px]">--</p>
                        </div>
                        <button id="logout-btn" class="text-red-500 hover:bg-red-50 p-2 rounded"><i class="fa-solid fa-power-off"></i></button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-1 w-full mx-auto p-4 lg:p-6 space-y-6 overflow-x-hidden">
            
            <!-- KPIs -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="glass-panel p-4 rounded-xl shadow-sm border-l-4 border-brand-500">
                    <p class="text-xs uppercase font-bold text-gray-400">Total Leads</p>
                    <h3 id="kpi-total" class="text-3xl font-bold">0</h3>
                </div>
                <div class="glass-panel p-4 rounded-xl shadow-sm border-l-4 border-yellow-400">
                    <p class="text-xs uppercase font-bold text-gray-400">Pendientes</p>
                    <h3 id="kpi-pending" class="text-3xl font-bold text-yellow-600">0</h3>
                </div>
                <div class="glass-panel p-4 rounded-xl shadow-sm border-l-4 border-green-500">
                    <p class="text-xs uppercase font-bold text-gray-400">Cerrados</p>
                    <h3 id="kpi-contacted" class="text-3xl font-bold text-green-600">0</h3>
                </div>
                <button id="export-btn" class="bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-lg flex flex-col justify-center items-center transition transform active:scale-95">
                    <i class="fa-solid fa-file-excel text-xl mb-1"></i>
                    <span class="text-xs font-bold">Exportar Excel</span>
                </button>
            </div>

            <!-- Controles -->
            <div class="flex flex-col lg:flex-row gap-4 justify-between items-center bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm">
                <div class="flex flex-wrap gap-2 w-full lg:w-auto">
                    <div class="relative flex-grow lg:flex-grow-0">
                        <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" id="search-input" placeholder="Buscar por nombre, email..." class="pl-10 pr-4 py-2 rounded-lg bg-gray-50 dark:bg-gray-900 border-none ring-1 ring-gray-200 dark:ring-gray-700 focus:ring-2 focus:ring-brand-500 w-full lg:w-64">
                    </div>
                    
                    <!-- Filtro Fecha -->
                    <select id="filter-date" class="py-2 px-4 rounded-lg bg-gray-50 dark:bg-gray-900 border-none ring-1 ring-gray-200 dark:ring-gray-700 cursor-pointer">
                        <option value="all">Todas las fechas</option>
                        <option value="today">Hoy</option>
                        <option value="week">Esta semana</option>
                    </select>

                    <!-- Filtro Curso (Din√°mico) -->
                    <select id="filter-course" class="py-2 px-4 rounded-lg bg-gray-50 dark:bg-gray-900 border-none ring-1 ring-gray-200 dark:ring-gray-700 cursor-pointer">
                        <option value="all">Todos los cursos</option>
                    </select>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="window.addColumn()" class="px-3 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm hover:bg-gray-200 transition text-brand-600 font-bold" title="Agregar columna personalizada"><i class="fa-solid fa-plus-circle"></i> Nueva Columna</button>
                    <div class="bg-gray-100 dark:bg-gray-700 p-1 rounded-lg flex">
                        <button onclick="switchView('table')" id="btn-view-table" class="px-3 py-1 rounded shadow bg-white dark:bg-gray-600 text-sm font-bold"><i class="fa-solid fa-table"></i></button>
                        <button onclick="switchView('kanban')" id="btn-view-kanban" class="px-3 py-1 rounded text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-600 text-sm"><i class="fa-solid fa-border-all"></i></button>
                    </div>
                    <button onclick="toggleTrash()" id="btn-trash" class="text-gray-400 hover:text-red-500 px-3 transition" title="Ver Papelera"><i class="fa-solid fa-trash-can text-lg"></i></button>
                </div>
            </div>

            <!-- VISTAS DE DATOS -->
            <div class="relative min-h-[500px]">
                
                <!-- VISTA TABLA -->
                <div id="view-table" class="fade-in bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden border border-gray-200 dark:border-gray-700">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead class="bg-gray-50 dark:bg-gray-900 text-xs uppercase font-bold text-gray-500 dark:text-gray-400">
                                <tr id="table-header-row">
                                    <th class="p-4">Score</th>
                                    <th class="p-4">Contacto</th>
                                    <th class="p-4">Inter√©s (Curso)</th>
                                    <th class="p-4">Mensaje Cliente</th>
                                    <th class="p-4">Notas Internas</th>
                                    <th class="p-4">Pr√≥x. Llamado</th>
                                    <th class="p-4">Compras</th>
                                    <th class="p-4 text-center">Estado</th>
                                    <!-- Aqu√≠ se insertar√°n columnas din√°micas -->
                                    <th class="p-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="text-sm divide-y divide-gray-100 dark:divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>

                <!-- VISTA KANBAN -->
                <div id="view-kanban" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 overflow-x-auto pb-4">
                    <div class="kanban-col bg-gray-50 dark:bg-gray-800/50 rounded-xl p-3 border border-gray-200 dark:border-gray-700">
                        <div class="font-bold mb-3 flex justify-between"><span>‚è≥ Pendientes</span> <span id="kb-count-pend" class="text-xs bg-gray-200 dark:bg-gray-700 px-2 rounded-full">0</span></div>
                        <div id="kanban-pending" class="space-y-3 min-h-[200px]" data-status="pendiente"></div>
                    </div>
                    <div class="kanban-col bg-gray-50 dark:bg-gray-800/50 rounded-xl p-3 border border-gray-200 dark:border-gray-700">
                        <div class="font-bold mb-3 flex justify-between"><span>üîÑ Seguimiento</span> <span id="kb-count-seg" class="text-xs bg-gray-200 dark:bg-gray-700 px-2 rounded-full">0</span></div>
                        <div id="kanban-progress" class="space-y-3 min-h-[200px]" data-status="seguimiento"></div>
                    </div>
                    <div class="kanban-col bg-gray-50 dark:bg-gray-800/50 rounded-xl p-3 border border-gray-200 dark:border-gray-700">
                        <div class="font-bold mb-3 flex justify-between"><span>‚úÖ Cerrados</span> <span id="kb-count-cont" class="text-xs bg-gray-200 dark:bg-gray-700 px-2 rounded-full">0</span></div>
                        <div id="kanban-contacted" class="space-y-3 min-h-[200px]" data-status="contactado"></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- === L√ìGICA JS COMPLETA === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. CONFIGURACI√ìN FIREBASE (Tus credenciales reales)
        const firebaseConfig = {
            apiKey: "AIzaSyDVlTFLAX1Ya28uoqQ-mqTFFakHxQ3GgVI",
            authDomain: "crm-programbi-9934a.firebaseapp.com",
            projectId: "crm-programbi-9934a",
            storageBucket: "crm-programbi-9934a.firebasestorage.app",
            messagingSenderId: "646856396244",
            appId: "1:646856396244:web:6caacd7c27b644f087da41"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables de Estado
        let allLeads = [];
        let isTrashMode = false;
        let currentView = 'table';
        
        // Columnas Personalizadas (Persistentes)
        let customColumns = JSON.parse(localStorage.getItem('crm_custom_columns') || '[]');
        
        // Plantillas (Persistentes)
        let templates = JSON.parse(localStorage.getItem('crm_templates')) || {
            whatsapp: [
                { title: 'üëã Saludo Inicial', text: 'Hola {nombre}, te hablo de ProgramBI por tu inter√©s en {curso}. ¬øC√≥mo puedo ayudarte?' },
                { title: 'üìÑ Info Curso', text: 'Hola {nombre}, aqu√≠ te dejo el temario de {curso} y los precios promocionales.' },
                { title: 'üìÖ Agendar Llamada', text: 'Hola {nombre}, ¬øtienes disponibilidad hoy para una breve llamada y explicarte mejor?' }
            ],
            email: [ 
                { title: 'Bienvenida', subject: 'Info {curso}', text: 'Hola {nombre},\n\nGracias por contactarnos...' } 
            ]
        };

        // 2. AUTENTICACI√ìN
        onAuthStateChanged(auth, u => {
            if(u){
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
                document.getElementById('user-display').textContent = u.email.split('@')[0];
                initData();
            } else {
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById('login-view').classList.remove('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async e => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); }
            catch(err) { Swal.fire('Error', 'Credenciales incorrectas', 'error'); }
        });
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        // 3. DATOS Y ESCUCHA EN TIEMPO REAL
        function initData() {
            onSnapshot(query(collection(db, "leads"), orderBy("fecha_creacion", "desc")), snap => {
                allLeads = [];
                const notifs = [];
                const courseSet = new Set();

                snap.forEach(d => {
                    const l = {id: d.id, ...d.data()};
                    allLeads.push(l);
                    
                    // Extraer cursos √∫nicos para el filtro
                    if(l.curso_interes) {
                        const simpleName = getCourseName(l.curso_interes);
                        if(simpleName) courseSet.add(simpleName);
                    }

                    // Notificaciones: Pendientes recientes (< 5 d√≠as)
                    if(l.fecha_creacion) {
                         const days = (new Date() - l.fecha_creacion.toDate())/(1000*3600*24);
                         if(days < 5 && l.status === 'pendiente') notifs.push(l);
                    }
                });

                updateKPIs();
                updateNotifs(notifs);
                populateCourseFilter(courseSet);
                renderApp();
            });
        }

        // L√≥gica Filtro Curso Inteligente
        function populateCourseFilter(set) {
            const sel = document.getElementById('filter-course');
            const currentVal = sel.value;
            sel.innerHTML = '<option value="all">Todos los cursos</option>';
            Array.from(set).sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.textContent = c; sel.appendChild(opt);
            });
            if(Array.from(set).includes(currentVal)) sel.value = currentVal;
        }

        function getCourseName(fullName) {
            if(!fullName) return "";
            if(fullName.includes("Power BI")) return "Power BI";
            if(fullName.includes("Excel")) return "Excel";
            if(fullName.includes("SQL")) return "SQL";
            if(fullName.includes("Python")) return "Python";
            return fullName.split(' ')[0];
        }

        // 4. RENDERIZADO PRINCIPAL
        window.renderApp = () => {
            const txt = document.getElementById('search-input').value.toLowerCase();
            const date = document.getElementById('filter-date').value;
            const course = document.getElementById('filter-course').value;

            const filtered = allLeads.filter(l => {
                // Filtro Papelera
                if(isTrashMode && l.status!=='trashed') return false;
                if(!isTrashMode && l.status==='trashed') return false;

                // Texto
                const matchTxt = (l.nombre||'').toLowerCase().includes(txt) || (l.email||'').toLowerCase().includes(txt);
                
                // Fecha
                let matchDate = true;
                if(l.fecha_creacion && date!=='all'){
                    const d = l.fecha_creacion.toDate();
                    const now = new Date();
                    if(date==='today') matchDate = d.toDateString()===now.toDateString();
                    if(date==='week') matchDate = (now-d) < 604800000;
                }

                // Curso
                let matchCourse = course==='all' ? true : (l.curso_interes||'').includes(course);
                
                return matchTxt && matchDate && matchCourse;
            });

            if(currentView === 'table') renderTable(filtered);
            else renderKanban(filtered);
        };

        function renderTable(list) {
            const thead = document.getElementById('table-header-row');
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            // Reconstruir Cabecera con Columnas Din√°micas
            let headerHTML = `
                <th class="p-4">Score</th>
                <th class="p-4">Contacto</th>
                <th class="p-4">Inter√©s (Curso)</th>
                <th class="p-4">Mensaje Cliente</th>
                <th class="p-4">Notas Internas</th>
                <th class="p-4">Pr√≥x. Llamado</th>
                <th class="p-4">Compras</th>
                <th class="p-4 text-center">Estado</th>
            `;
            // Agregar cabeceras personalizadas
            customColumns.forEach(col => {
                headerHTML += `<th class="p-4 text-blue-600 cursor-pointer" onclick="window.removeColumn('${col}')" title="Clic para eliminar">${col}</th>`;
            });
            headerHTML += `<th class="p-4 text-center">Acciones</th>`;
            thead.innerHTML = headerHTML;

            if(!list.length) { tbody.innerHTML='<tr><td colspan="15" class="p-4 text-center text-gray-400">Sin datos</td></tr>'; return; }

            list.forEach(l => {
                const isCorp = isCorporate(l.email);
                const courses = (l.curso_interes||'').split(',').map(c => c.trim());
                
                // Etiquetas de Colores
                const courseTags = courses.map(c => {
                    let tagClass = 'tag-default';
                    if(c.includes('Power BI')) tagClass = 'tag-powerbi';
                    if(c.includes('Excel')) tagClass = 'tag-excel';
                    if(c.includes('SQL')) tagClass = 'tag-sql';
                    if(c.includes('Python')) tagClass = 'tag-python';
                    return `<span class="text-[10px] px-2 py-0.5 rounded border mr-1 mb-1 inline-block ${tagClass}">${c}</span>`;
                }).join('');

                const buys = (l.compras||[]).map(c => `<span class="text-[10px] bg-green-600 text-white px-1 rounded mr-1" title="Comprado">‚úî ${c}</span>`).join('');
                
                // Pr√≥ximo Llamado
                let nextCallHTML = '<span class="text-xs text-gray-400 cursor-pointer hover:text-brand-500">Programar</span>';
                if(l.proximo_llamado) {
                    const d = new Date(l.proximo_llamado);
                    const isLate = new Date() > d;
                    nextCallHTML = `<span class="${isLate ? 'text-red-600 font-bold' : 'text-blue-600'} text-xs cursor-pointer hover:underline">${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`;
                }

                // Generar Celdas Personalizadas
                let customCells = '';
                customColumns.forEach(col => {
                    const val = (l.custom_fields && l.custom_fields[col]) || '';
                    customCells += `
                        <td class="p-4 border-l border-gray-100 dark:border-gray-700">
                            <div class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-1 rounded text-xs min-h-[20px] min-w-[50px] text-gray-600 dark:text-gray-300" 
                                 onclick="window.editCustomField('${l.id}', '${col}', '${val}')">
                                ${val || '<span class="text-gray-300 italic">...</span>'}
                            </div>
                        </td>`;
                });

                const tr = document.createElement('tr');
                tr.className = `border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition ${isCorp ? 'bg-blue-50/30 dark:bg-blue-900/10 border-l-4 border-l-blue-500' : ''}`;
                
                tr.innerHTML = `
                    <td class="p-4 text-xs">‚≠ê</td>
                    <td class="p-4">
                        <div class="font-bold text-gray-800 dark:text-gray-100">${l.nombre} ${isCorp ? '<i class="fa-solid fa-building text-blue-500 ml-1" title="Empresa"></i>' : ''}</div>
                        <div class="text-xs text-gray-500">${l.telefono}</div>
                    </td>
                    <td class="p-4"><div class="flex flex-wrap max-w-[150px]">${courseTags}</div></td>
                    <td class="p-4">
                        <div class="text-xs text-gray-500 truncate max-w-[150px]" title="${l.mensaje}">${l.mensaje || '-'}</div>
                    </td>
                    <td class="p-4">
                        <div class="cursor-pointer hover:bg-yellow-50 dark:hover:bg-yellow-900/20 p-1 rounded text-xs text-gray-600 dark:text-gray-400 truncate max-w-[150px]" onclick="window.editNote('${l.id}', '${l.observaciones||''}')">
                            ${l.observaciones ? 'üìù ' + l.observaciones : '<span class="italic text-gray-300">Agregar nota...</span>'}
                        </div>
                    </td>
                    <td class="p-4" onclick="window.openNextCall('${l.id}')">${nextCallHTML}</td>
                    <td class="p-4" onclick="window.togglePurchase('${l.id}', '${l.compras||''}')">
                        ${buys || '<span class="text-gray-300 text-xs cursor-pointer hover:text-green-500">+ Agregar</span>'}
                    </td>
                    <td class="p-4 text-center">
                        <span onclick="window.toggleStatus('${l.id}','${l.status}')" class="px-2 py-1 rounded-full text-xs font-bold cursor-pointer hover:scale-105 inline-block ${l.status==='contactado'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}">${l.status}</span>
                    </td>
                    ${customCells}
                    <td class="p-4 text-center flex gap-2 justify-center">
                        <button onclick="window.openCall('${l.telefono}')" class="text-blue-500 hover:bg-blue-100 p-2 rounded-full" title="Llamar"><i class="fa-solid fa-phone"></i></button>
                        <button onclick="window.openWACards('${l.telefono}','${l.nombre}','${l.curso_interes}')" class="text-green-500 hover:bg-green-100 p-2 rounded-full" title="WhatsApp"><i class="fab fa-whatsapp text-lg"></i></button>
                        <button onclick="window.openEmailTemplate('${l.email}','${l.nombre}')" class="text-indigo-500 hover:bg-indigo-100 p-2 rounded-full"><i class="fa-solid fa-envelope"></i></button>
                        ${isTrashMode ? 
                            `<button onclick="window.restore('${l.id}')" class="text-green-600"><i class="fa-solid fa-trash-arrow-up"></i></button>` : 
                            `<button onclick="window.trash('${l.id}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>`
                        }
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Kanban Simplificado (Solo muestra tarjetas, la edici√≥n full est√° en Tabla)
        function renderKanban(list) {
             const cols = {
                pendiente: document.getElementById('kanban-pending'),
                seguimiento: document.getElementById('kanban-progress'),
                contactado: document.getElementById('kanban-contacted')
            };
            Object.values(cols).forEach(c => c.innerHTML = '');
            list.forEach(l => {
                const col = cols[l.status] || cols['pendiente'];
                const div = document.createElement('div');
                div.className = `bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm mb-3 ${isCorporate(l.email)?'is-corporate-card':''}`;
                div.innerHTML = `
                    <div class="flex justify-between font-bold text-sm"><span>${l.nombre}</span> <button onclick="window.openWACards('${l.telefono}','${l.nombre}','${l.curso_interes}')" class="text-green-500"><i class="fab fa-whatsapp"></i></button></div>
                    <div class="text-xs text-gray-500 mt-1">${l.curso_interes}</div>
                    ${l.proximo_llamado ? `<div class="text-[10px] mt-2 text-blue-500 bg-blue-50 inline-block px-1 rounded">üìû ${new Date(l.proximo_llamado).toLocaleDateString()}</div>` : ''}
                `;
                col.appendChild(div);
            });
            // Init Drag & Drop
            Object.values(cols).forEach(el => {
                new Sortable(el, { group: 'kanban', animation: 150, onEnd: async evt => {
                    const statusMap = ['pendiente','seguimiento','contactado'];
                    const newStatus = evt.to.id.replace('kanban-','').replace('pending','pendiente').replace('progress','seguimiento').replace('contacted','contactado'); // Map simple
                    // En un kanban real necesitar√≠amos el ID del lead en el elemento. Omitido por brevedad en "Todo en uno".
                }});
            });
        }

        // --- ACCIONES ---

        // 1. WhatsApp Card
        window.openWACards = (phone, name, course) => {
            if(!phone) return Swal.fire('Sin tel√©fono');
            const p = phone.replace(/\D/g, ''); const finalPhone = p.length===9 ? '56'+p : p;

            const cardsHTML = templates.whatsapp.map((t, i) => `
                <div onclick="selectWATemplate(${i}, '${finalPhone}', '${name}', '${course}')" class="cursor-pointer bg-gray-50 dark:bg-gray-700 p-3 rounded-lg border hover:border-green-500 hover:bg-green-50 transition text-left mb-2">
                    <div class="font-bold text-sm text-gray-800 dark:text-white mb-1">${t.title}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 truncate">${t.text}</div>
                </div>
            `).join('');

            Swal.fire({ title: 'Selecciona Mensaje', html: `<div class="max-h-60 overflow-y-auto">${cardsHTML}</div>`, showConfirmButton: false, showCloseButton: true });
        };
        window.selectWATemplate = async (index, phone, name, course) => {
            Swal.close();
            let msg = templates.whatsapp[index].text.replace('{nombre}', name).replace('{curso}', course || 'el curso');
            const { value: finalMsg } = await Swal.fire({ input: 'textarea', inputValue: msg, title: 'Editar antes de enviar', confirmButtonText: 'Abrir WhatsApp <i class="fab fa-whatsapp"></i>', confirmButtonColor: '#25D366', showCancelButton: true });
            if(finalMsg) window.open(`https://wa.me/${phone}?text=${encodeURIComponent(finalMsg)}`, '_blank');
        };

        // 2. Email Template
        window.openEmailTemplate = async (email, name) => {
             if(!email) return Swal.fire('Sin email');
             const cardsHTML = templates.email.map((t, i) => `
                <div onclick="selectEmailTemplate(${i}, '${email}', '${name}')" class="cursor-pointer bg-gray-50 dark:bg-gray-700 p-3 rounded-lg border hover:border-blue-500 hover:bg-blue-50 transition text-left mb-2">
                    <div class="font-bold text-sm text-gray-800 dark:text-white mb-1">${t.title}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 truncate">${t.subject}</div>
                </div>
            `).join('');
            Swal.fire({ title: 'Selecciona Email', html: `<div class="max-h-60 overflow-y-auto">${cardsHTML}</div>`, showConfirmButton: false, showCloseButton: true });
        };
        window.selectEmailTemplate = async (index, email, name) => {
             Swal.close();
             const t = templates.email[index];
             let body = t.text.replace('{nombre}', name);
             const { value: finalBody } = await Swal.fire({ input: 'textarea', inputValue: body, title: 'Editar Cuerpo', confirmButtonText: 'Abrir Cliente de Correo', showCancelButton: true });
             if(finalBody) window.location.href = `mailto:${email}?subject=${encodeURIComponent(t.subject)}&body=${encodeURIComponent(finalBody)}`;
        };

        // 3. Pr√≥ximo Llamado
        window.openNextCall = async (id) => {
            const { value: date } = await Swal.fire({ title: 'Programar Llamada', html: '<input type="datetime-local" id="swal-date" class="swal2-input">', preConfirm: () => document.getElementById('swal-date').value });
            if(date) { await updateDoc(doc(db,"leads",id), { proximo_llamado: date }); Swal.fire({toast:true, icon:'success', title:'Agendado', position:'top-end', timer:1500, showConfirmButton:false}); }
        };

        // 4. Compras (Tags)
        window.togglePurchase = async (id, currentStr) => {
            let current = Array.isArray(currentStr) ? currentStr : [];
            const { value: formValues } = await Swal.fire({
                title: 'Registrar Compra',
                html: `<div class="space-y-2 text-left">
                        <label class="flex items-center"><input type="checkbox" id="chk-pbi" ${current.includes('Power BI')?'checked':''}> Power BI</label>
                        <label class="flex items-center"><input type="checkbox" id="chk-sql" ${current.includes('SQL')?'checked':''}> SQL</label>
                        <label class="flex items-center"><input type="checkbox" id="chk-py" ${current.includes('Python')?'checked':''}> Python</label>
                        <label class="flex items-center"><input type="checkbox" id="chk-excel" ${current.includes('Excel')?'checked':''}> Excel</label>
                    </div>`,
                preConfirm: () => {
                    const res = [];
                    if(document.getElementById('chk-pbi').checked) res.push('Power BI');
                    if(document.getElementById('chk-sql').checked) res.push('SQL');
                    if(document.getElementById('chk-py').checked) res.push('Python');
                    if(document.getElementById('chk-excel').checked) res.push('Excel');
                    return res;
                }
            });
            if(formValues) await updateDoc(doc(db,"leads",id), { compras: formValues, status: 'contactado' });
        };

        // 5. Columnas Personalizadas
        window.addColumn = async () => {
            const { value: name } = await Swal.fire({ input: 'text', title: 'Nombre Nueva Columna', inputPlaceholder: 'Ej. Direcci√≥n' });
            if(name && !customColumns.includes(name)) {
                customColumns.push(name);
                localStorage.setItem('crm_custom_columns', JSON.stringify(customColumns));
                renderApp();
            }
        };
        window.removeColumn = async (name) => {
            const res = await Swal.fire({ title: `¬øBorrar columna "${name}"?`, text: "Los datos no se borran, solo se ocultan.", icon: 'warning', showCancelButton: true });
            if(res.isConfirmed) {
                customColumns = customColumns.filter(c => c !== name);
                localStorage.setItem('crm_custom_columns', JSON.stringify(customColumns));
                renderApp();
            }
        };
        window.editCustomField = async (id, col, currentVal) => {
             const { value: val } = await Swal.fire({ input: 'text', title: `Editar ${col}`, inputValue: currentVal });
             if(val !== undefined) {
                 // Firestore update map field
                 const fieldPath = `custom_fields.${col}`;
                 await updateDoc(doc(db,"leads",id), { [fieldPath]: val });
             }
        };

        // 6. Configurar Plantillas
        window.openTemplateConfig = async () => {
            const { value: type } = await Swal.fire({ title: 'Configurar Plantillas', input: 'radio', inputOptions: { 'whatsapp': 'WhatsApp', 'email': 'Email' }, inputValue: 'whatsapp' });
            if(type) {
                const list = templates[type].map((t,i) => `<div class="flex justify-between items-center bg-gray-100 p-2 mb-2 rounded"><div class="text-left text-xs truncate w-48 font-bold">${t.title}</div><button onclick="deleteTemplate('${type}',${i})" class="text-red-500"><i class="fa-solid fa-trash"></i></button></div>`).join('');
                Swal.fire({ title: `Plantillas ${type}`, html: `<div class="mb-4 max-h-40 overflow-y-auto">${list}</div><button onclick="addTemplate('${type}')" class="bg-blue-500 text-white px-4 py-2 rounded text-sm w-full">+ Crear Nueva</button>`, showConfirmButton: false, showCloseButton: true });
            }
        };
        window.addTemplate = async (type) => {
            Swal.close();
            const inputs = type === 'email' 
                ? `<input id="swal-title" class="swal2-input" placeholder="Nombre Plantilla"><input id="swal-subj" class="swal2-input" placeholder="Asunto"><textarea id="swal-text" class="swal2-textarea" placeholder="Cuerpo..."></textarea>`
                : `<input id="swal-title" class="swal2-input" placeholder="Nombre Plantilla"><textarea id="swal-text" class="swal2-textarea" placeholder="Mensaje..."></textarea>`;
            
            const { value: form } = await Swal.fire({ title: 'Nueva Plantilla', html: inputs, preConfirm: () => ({ title: document.getElementById('swal-title').value, subject: document.getElementById('swal-subj')?.value, text: document.getElementById('swal-text').value }) });
            
            if(form && form.title) { templates[type].push(form); localStorage.setItem('crm_templates', JSON.stringify(templates)); Swal.fire('Guardado', '', 'success'); }
        };
        window.deleteTemplate = (type, index) => { templates[type].splice(index, 1); localStorage.setItem('crm_templates', JSON.stringify(templates)); Swal.close(); Swal.fire('Borrado', '', 'success'); };

        // Helpers Gen√©ricos
        window.switchView = v => { currentView = v; document.getElementById('view-table').classList.toggle('hidden', v!=='table'); document.getElementById('view-kanban').classList.toggle('hidden', v!=='kanban'); renderApp(); };
        window.toggleTrash = () => { isTrashMode = !isTrashMode; document.getElementById('btn-trash').classList.toggle('text-red-600'); renderApp(); };
        window.openCall = p => window.location.href = `tel:${p}`;
        window.toggleStatus = async (id, s) => await updateDoc(doc(db,"leads",id), {status: s==='contactado'?'pendiente':'contactado'});
        window.trash = async id => await updateDoc(doc(db,"leads",id), {status:'trashed'});
        window.restore = async id => await updateDoc(doc(db,"leads",id), {status:'pendiente'});
        window.editNote = async (id, val) => { const {value:t} = await Swal.fire({input:'textarea', inputValue:val}); if(t!==undefined) await updateDoc(doc(db,"leads",id), {observaciones:t}); };
        
        function updateKPIs() { const active = allLeads.filter(l => l.status!=='trashed'); document.getElementById('kpi-total').textContent = active.length; document.getElementById('kpi-pending').textContent = active.filter(l=>l.status==='pendiente').length; document.getElementById('kpi-contacted').textContent = active.filter(l=>l.status==='contactado').length; }
        
        function updateNotifs(list) {
            const el = document.getElementById('notif-list'); const badge = document.getElementById('notif-badge'); el.innerHTML = '';
            if(list.length > 0) { badge.classList.remove('hidden'); list.forEach(l => { const div = document.createElement('div'); div.className = "p-3 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer text-sm"; div.innerHTML = `<b>${l.nombre}</b> <span class="text-xs text-gray-500">hace d√≠as</span><br><span class="text-xs text-brand-500">${l.curso_interes}</span>`; div.onclick = () => { document.getElementById('search-input').value = l.email; renderApp(); document.getElementById('notif-dropdown').classList.add('hidden'); }; el.appendChild(div); }); } 
            else { badge.classList.add('hidden'); el.innerHTML = '<div class="p-4 text-center text-gray-400 text-xs">Sin novedades</div>'; }
        }
        document.getElementById('notif-btn').onclick = (e) => { e.stopPropagation(); document.getElementById('notif-dropdown').classList.toggle('hidden'); };
        window.onclick = () => document.getElementById('notif-dropdown').classList.add('hidden');
        function isCorporate(e) { return !['gmail.com','hotmail.com','outlook.com','yahoo.com'].some(d => (e||'').includes(d)); }

        // Eventos
        document.getElementById('search-input').onkeyup = renderApp;
        document.getElementById('filter-date').onchange = renderApp;
        document.getElementById('filter-course').onchange = renderApp;

        if(localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
        document.getElementById('theme-toggle').onclick = () => { document.documentElement.classList.toggle('dark'); localStorage.theme = document.documentElement.classList.contains('dark')?'dark':'light'; };

    </script>
</body>
</html>
