dex.html
HTML
<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM Director - Ultimate</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuraci√≥n Tailwind para Modo Oscuro -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        glass: "rgba(255, 255, 255, 0.7)",
                        darkGlass: "rgba(17, 24, 39, 0.8)",
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' }
                    }
                }
            }
        }
    </script>
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- SweetAlert2 (Alertas) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Chart.js (Gr√°ficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SortableJS (Drag & Drop) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>

    <style>
        /* Estilos Base y Animaciones */
        body { font-family: 'Segoe UI', system-ui, sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass-panel {
            background: rgba(17, 24, 39, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Scrollbar Personalizado */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        /* Animaciones */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .highlight-row { animation: pulse-blue 2s infinite; }

        /* Kanban Styles */
        .kanban-col { min-height: 200px; }
        .sortable-ghost { opacity: 0.4; background: #e2e8f0; border: 2px dashed #94a3b8; }
        
        /* Estilos corporativos */
        .is-corporate-card { border-left: 4px solid #3b82f6 !important; background: linear-gradient(to right, #eff6ff, white); }
        .dark .is-corporate-card { border-left: 4px solid #3b82f6 !important; background: linear-gradient(to right, #1e3a8a30, #111827); }

        /* Tooltip personalizado para mensajes */
        .tooltip-container:hover .custom-tooltip { opacity: 1; visibility: visible; transform: translateY(0); }
        .custom-tooltip {
            transition: all 0.2s ease;
            transform: translateY(10px);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 min-h-screen selection:bg-brand-500 selection:text-white">

    <!-- === VISTA LOGIN === -->
    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-[url('https://images.unsplash.com/photo-1497215728101-856f4ea42174?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80')] bg-cover bg-center">
        <div class="absolute inset-0 bg-brand-900/80 backdrop-blur-sm"></div>
        
        <div class="relative glass-panel p-8 rounded-3xl shadow-2xl w-full max-w-md border-t border-white/20">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-tr from-brand-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-brand-500/30 transform -rotate-6">
                    <i class="fa-solid fa-chart-simple text-4xl text-white"></i>
                </div>
                <h2 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-brand-600 to-purple-600 dark:from-brand-400 dark:to-purple-400">CRM Director</h2>
                <p class="text-gray-500 dark:text-gray-400 text-sm mt-2 font-medium">Acceso Seguro</p>
            </div>
            
            <form id="login-form" class="space-y-5">
                <div class="relative">
                    <i class="fa-solid fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="email" id="login-email" class="w-full pl-12 pr-4 py-4 rounded-xl bg-gray-50 dark:bg-gray-800 border-none focus:ring-2 focus:ring-brand-500 transition-all dark:text-white" placeholder="admin@empresa.com" required>
                </div>
                <div class="relative">
                    <i class="fa-solid fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="password" id="login-password" class="w-full pl-12 pr-4 py-4 rounded-xl bg-gray-50 dark:bg-gray-800 border-none focus:ring-2 focus:ring-brand-500 transition-all dark:text-white" placeholder="Contrase√±a" required>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-brand-600 to-purple-600 hover:from-brand-700 hover:to-purple-700 text-white font-bold py-4 rounded-xl shadow-xl shadow-brand-500/20 transform hover:scale-[1.02] transition-all">
                    Entrar al Sistema
                </button>
            </form>
        </div>
    </div>

    <!-- === VISTA DASHBOARD === -->
    <div id="dashboard-view" class="hidden min-h-screen flex flex-col transition-all duration-300">
        
        <!-- Navbar Superior -->
        <nav class="glass-panel sticky top-0 z-40 border-b shadow-sm">
            <div class="max-w-7xl mx-auto px-4 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <!-- Logo & Modo -->
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <div class="bg-brand-600 text-white w-8 h-8 rounded-lg flex items-center justify-center font-bold text-lg">D</div>
                            <span class="font-bold text-lg tracking-tight hidden sm:block">Director<span class="text-brand-600 dark:text-brand-400">CRM</span></span>
                        </div>
                        <div class="h-6 w-px bg-gray-300 dark:bg-gray-700"></div>
                        <!-- Toggle Modo Oscuro -->
                        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition text-gray-600 dark:text-gray-300">
                            <i class="fa-solid fa-moon dark:hidden"></i>
                            <i class="fa-solid fa-sun hidden dark:block text-yellow-400"></i>
                        </button>
                    </div>

                    <!-- Usuario & Acciones -->
                    <div class="flex items-center gap-3">
                        <!-- Notificaciones Dropdown -->
                        <div class="relative">
                            <button id="notif-btn" class="relative p-2 text-gray-500 hover:text-brand-600 transition" title="Notificaciones">
                                <i class="fa-regular fa-bell text-xl"></i>
                                <span id="notif-badge" class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                            </button>
                            <!-- Panel Flotante -->
                            <div id="notif-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-100 dark:border-gray-700 overflow-hidden z-50">
                                <div class="p-3 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900 font-bold text-sm">Notificaciones</div>
                                <div id="notif-list" class="max-h-64 overflow-y-auto">
                                    <!-- Items insertados con JS -->
                                </div>
                            </div>
                        </div>

                        <div class="text-right hidden sm:block leading-tight">
                            <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Conectado como</p>
                            <p id="user-display" class="text-sm font-bold truncate max-w-[150px]">Usuario</p>
                        </div>
                        <button id="logout-btn" class="bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 p-2 rounded-lg hover:bg-red-100 transition shadow-sm">
                            <i class="fa-solid fa-power-off"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-1 max-w-7xl w-full mx-auto p-4 sm:p-6 lg:p-8 space-y-8">
            
            <!-- 1. KPIs & Gr√°fico (Layout Grid) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Columna Izquierda: Tarjetas KPI -->
                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Total -->
                    <div class="glass-panel p-5 rounded-2xl shadow-sm relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-brand-500/10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                        <div class="relative z-10">
                            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold uppercase tracking-wider">Total Leads</p>
                            <div class="flex items-end gap-2 mt-1">
                                <h3 id="kpi-total" class="text-4xl font-bold text-gray-800 dark:text-white">0</h3>
                                <span class="text-xs text-green-500 font-medium mb-1.5"><i class="fa-solid fa-arrow-trend-up"></i> Global</span>
                            </div>
                        </div>
                    </div>
                    <!-- Pendientes (Urgente) -->
                    <div class="glass-panel p-5 rounded-2xl shadow-sm border-l-4 border-yellow-400 relative overflow-hidden">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-yellow-500/10 rounded-bl-full -mr-4 -mt-4"></div>
                        <div class="relative z-10">
                            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold uppercase tracking-wider">Por Contactar</p>
                            <h3 id="kpi-pending" class="text-4xl font-bold text-yellow-600 dark:text-yellow-400 mt-1">0</h3>
                        </div>
                    </div>
                    <!-- Contactados -->
                    <div class="glass-panel p-5 rounded-2xl shadow-sm border-l-4 border-green-500 relative overflow-hidden">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-green-500/10 rounded-bl-full -mr-4 -mt-4"></div>
                        <div class="relative z-10">
                            <p class="text-gray-500 dark:text-gray-400 text-xs font-bold uppercase tracking-wider">Cerrados</p>
                            <h3 id="kpi-contacted" class="text-4xl font-bold text-green-600 dark:text-green-400 mt-1">0</h3>
                        </div>
                    </div>
                    <!-- Acci√≥n R√°pida -->
                    <button id="export-btn" class="bg-gradient-to-br from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white rounded-2xl p-5 shadow-lg shadow-green-500/20 flex flex-col justify-center items-center gap-2 transition-all active:scale-95 group">
                        <i class="fa-solid fa-file-excel text-2xl group-hover:animate-bounce"></i>
                        <span class="font-bold text-sm">Exportar Excel</span>
                    </button>
                </div>

                <!-- Columna Derecha: Gr√°fico de Tendencia -->
                <div class="glass-panel p-5 rounded-2xl shadow-sm flex flex-col justify-between h-64 lg:h-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-bold text-sm text-gray-700 dark:text-gray-200">Tendencia (7 d√≠as)</h4>
                        <span class="text-xs text-brand-500 bg-brand-50 dark:bg-brand-900/30 px-2 py-1 rounded-md">En vivo</span>
                    </div>
                    <div class="flex-1 relative w-full h-full">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 2. Barra de Control (Filtros & Vistas) -->
            <div class="flex flex-col lg:flex-row justify-between items-center gap-4 bg-white dark:bg-gray-800 p-2 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                
                <!-- Buscador y Fecha -->
                <div class="flex flex-col sm:flex-row gap-2 w-full lg:w-auto">
                    <div class="relative group">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-brand-500"></i>
                        <input type="text" id="search-input" placeholder="Buscar..." class="w-full sm:w-48 pl-10 pr-4 py-2.5 rounded-xl bg-gray-50 dark:bg-gray-900 border-none focus:ring-2 focus:ring-brand-500 text-sm dark:text-white transition-all">
                    </div>
                    
                    <!-- Filtro Fecha -->
                    <div class="relative">
                         <i class="fa-regular fa-calendar absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <select id="filter-date" class="pl-10 pr-8 py-2.5 rounded-xl bg-gray-50 dark:bg-gray-900 border-none focus:ring-2 focus:ring-brand-500 text-sm dark:text-white cursor-pointer appearance-none">
                            <option value="all">Toda la historia</option>
                            <option value="today">Hoy</option>
                            <option value="week">Esta Semana</option>
                            <option value="month">Este Mes</option>
                        </select>
                    </div>

                    <!-- NUEVO: Filtro Curso -->
                    <div class="relative">
                        <i class="fa-solid fa-graduation-cap absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                       <select id="filter-course" class="pl-10 pr-8 py-2.5 rounded-xl bg-gray-50 dark:bg-gray-900 border-none focus:ring-2 focus:ring-brand-500 text-sm dark:text-white cursor-pointer appearance-none">
                           <option value="all">Todos los cursos</option>
                           <option value="Power BI">Power BI</option>
                           <option value="Python">Python</option>
                           <option value="SQL">SQL</option>
                       </select>
                   </div>
                </div>

                <!-- Selector de Vistas y Papelera -->
                <div class="flex items-center bg-gray-100 dark:bg-gray-900 p-1 rounded-xl w-full sm:w-auto justify-center">
                    <button onclick="switchView('table')" id="btn-view-table" class="flex-1 sm:flex-none px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-sm bg-white dark:bg-gray-700 text-brand-600 dark:text-white">
                        <i class="fa-solid fa-table mr-2"></i>Tabla
                    </button>
                    <button onclick="switchView('kanban')" id="btn-view-kanban" class="flex-1 sm:flex-none px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 transition-all">
                        <i class="fa-solid fa-border-all mr-2"></i>Kanban
                    </button>
                    <button onclick="toggleTrash()" id="btn-trash" class="ml-2 px-3 py-2 rounded-lg text-gray-400 hover:text-red-500 transition tooltip" title="Papelera">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            </div>

            <!-- 3. Contenedor de Vistas -->
            <div class="relative min-h-[400px]">
                
                <!-- VISTA TABLA -->
                <div id="view-table" class="fade-in glass-panel rounded-2xl shadow-sm overflow-hidden flex flex-col">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-50/50 dark:bg-gray-800/50 text-gray-500 dark:text-gray-400 text-xs uppercase font-bold border-b border-gray-100 dark:border-gray-700">
                                <tr>
                                    <th class="p-4">Lead Score</th>
                                    <th class="p-4">Contacto</th>
                                    <th class="p-4">Inter√©s</th>
                                    <th class="p-4 text-center">Estado</th>
                                    <th class="p-4 text-center">Notas</th>
                                    <th class="p-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="text-sm divide-y divide-gray-100 dark:divide-gray-800">
                                <!-- Filas JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- VISTA KANBAN (Trello Style) -->
                <div id="view-kanban" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6 h-full overflow-x-auto pb-4">
                    <!-- Columna Pendiente -->
                    <div class="flex flex-col h-full bg-gray-50 dark:bg-gray-800/50 rounded-2xl p-4 border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-700 dark:text-gray-200"><i class="fa-regular fa-clock text-yellow-500 mr-2"></i>Pendientes</h3>
                            <span id="count-kanban-pending" class="bg-gray-200 dark:bg-gray-700 text-xs px-2 py-1 rounded-full font-bold">0</span>
                        </div>
                        <div id="kanban-pending" class="kanban-col flex-1 space-y-3" data-status="pendiente"></div>
                    </div>
                    
                    <!-- Columna En Proceso (Nueva l√≥gica para notas/en conversaci√≥n) -->
                    <div class="flex flex-col h-full bg-gray-50 dark:bg-gray-800/50 rounded-2xl p-4 border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-700 dark:text-gray-200"><i class="fa-solid fa-spinner text-blue-500 mr-2"></i>Seguimiento</h3>
                             <span id="count-kanban-progress" class="bg-gray-200 dark:bg-gray-700 text-xs px-2 py-1 rounded-full font-bold">0</span>
                        </div>
                        <div id="kanban-progress" class="kanban-col flex-1 space-y-3" data-status="seguimiento"></div>
                    </div>

                    <!-- Columna Contactado/Cerrado -->
                    <div class="flex flex-col h-full bg-gray-50 dark:bg-gray-800/50 rounded-2xl p-4 border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-700 dark:text-gray-200"><i class="fa-solid fa-check-circle text-green-500 mr-2"></i>Cerrados</h3>
                             <span id="count-kanban-contacted" class="bg-gray-200 dark:bg-gray-700 text-xs px-2 py-1 rounded-full font-bold">0</span>
                        </div>
                        <div id="kanban-contacted" class="kanban-col flex-1 space-y-3" data-status="contactado"></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- === L√ìGICA JAVASCRIPT INTEGRAL === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. CONFIGURACI√ìN
        const firebaseConfig = {
            apiKey: "AIzaSyDVlTFLAX1Ya28uoqQ-mqTFFakHxQ3GgVI",
            authDomain: "crm-programbi-9934a.firebaseapp.com",
            projectId: "crm-programbi-9934a",
            storageBucket: "crm-programbi-9934a.firebasestorage.app",
            messagingSenderId: "646856396244",
            appId: "1:646856396244:web:6caacd7c27b644f087da41"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables Globales
        let allLeads = [];
        let isTrashMode = false;
        let currentView = 'table';
        let trendChartInstance = null;
        let recentNotifications = [];

        // 2. INICIO & AUTH
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
                document.getElementById('user-display').textContent = user.email.split('@')[0];
                initDataListener();
            } else {
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById('login-view').classList.remove('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value);
            } catch (err) { Swal.fire({icon:'error', title:'Error', text:'Credenciales incorrectas', toast:true, position:'top-end', showConfirmButton:false, timer:3000}); }
        });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // 3. LOGICA PRINCIPAL (Datos)
        function initDataListener() {
            const q = query(collection(db, "leads"), orderBy("fecha_creacion", "desc"));
            onSnapshot(q, (snapshot) => {
                allLeads = [];
                const last7Days = Array(7).fill(0); // Para gr√°fico
                
                // Reiniciar notificaciones
                recentNotifications = [];

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const lead = { id: docSnap.id, ...data };
                    allLeads.push(lead);

                    // L√≥gica para Gr√°fico
                    if (data.fecha_creacion) {
                        const date = data.fecha_creacion.toDate();
                        const diffTime = Math.abs(new Date() - date);
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays < 7) last7Days[6 - diffDays]++;
                        
                        // L√≥gica Notificaciones (Leads recientes < 7 d√≠as y no contactados)
                        if (diffDays < 7 && lead.status === 'pendiente' && lead.status !== 'trashed') {
                            recentNotifications.push(lead);
                        }
                    }
                });

                updateKPIs();
                updateChart(last7Days);
                updateNotificationsUI();
                renderApp();
            });
        }

        function updateNotificationsUI() {
            const list = document.getElementById('notif-list');
            const badge = document.getElementById('notif-badge');
            
            list.innerHTML = '';
            
            if (recentNotifications.length > 0) {
                badge.classList.remove('hidden');
                recentNotifications.forEach(lead => {
                    const div = document.createElement('div');
                    div.className = "p-3 border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition";
                    div.innerHTML = `
                        <div class="flex justify-between">
                            <span class="font-bold text-sm text-gray-800 dark:text-gray-200">${lead.nombre}</span>
                            <span class="text-xs text-brand-500">${timeAgo(lead.fecha_creacion.toDate())}</span>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${lead.curso_interes}</p>
                    `;
                    div.onclick = () => {
                        // Al hacer clic: cerrar dropdown, llenar buscador con email y renderizar
                        document.getElementById('notif-dropdown').classList.add('hidden');
                        document.getElementById('search-input').value = lead.email;
                        renderApp();
                        Swal.fire({
                            toast: true, 
                            icon: 'info', 
                            title: `Mostrando lead: ${lead.nombre}`, 
                            position: 'top-end', 
                            showConfirmButton: false, 
                            timer: 2000
                        });
                    };
                    list.appendChild(div);
                });
            } else {
                badge.classList.add('hidden');
                list.innerHTML = '<div class="p-4 text-center text-xs text-gray-400">Sin notificaciones nuevas</div>';
            }
        }

        // Toggle dropdown notificaciones
        document.getElementById('notif-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('notif-dropdown').classList.toggle('hidden');
        });
        // Cerrar al hacer click fuera
        window.addEventListener('click', () => {
             document.getElementById('notif-dropdown').classList.add('hidden');
        });


        function updateKPIs() {
            const activeLeads = allLeads.filter(l => l.status !== 'trashed');
            document.getElementById('kpi-total').textContent = activeLeads.length;
            document.getElementById('kpi-pending').textContent = activeLeads.filter(l => l.status === 'pendiente').length;
            document.getElementById('kpi-contacted').textContent = activeLeads.filter(l => l.status === 'contactado').length;
        }

        // 4. RENDERIZADO
        window.renderApp = () => {
            const filterText = document.getElementById('search-input').value.toLowerCase();
            const filterDate = document.getElementById('filter-date').value;
            const filterCourse = document.getElementById('filter-course').value;

            // Filtros combinados
            const filtered = allLeads.filter(lead => {
                // Filtro Papelera
                if (isTrashMode && lead.status !== 'trashed') return false;
                if (!isTrashMode && lead.status === 'trashed') return false;

                // Filtro Texto
                const matchText = (lead.nombre||'').toLowerCase().includes(filterText) || (lead.email||'').toLowerCase().includes(filterText);
                
                // Filtro Fecha
                let matchDate = true;
                if (lead.fecha_creacion && filterDate !== 'all') {
                    const d = lead.fecha_creacion.toDate();
                    const now = new Date();
                    if (filterDate === 'today') matchDate = d.toDateString() === now.toDateString();
                    if (filterDate === 'week') matchDate = (now - d) < 604800000;
                    if (filterDate === 'month') matchDate = d.getMonth() === now.getMonth();
                }

                // Filtro Curso
                let matchCourse = true;
                if (filterCourse !== 'all') {
                    matchCourse = (lead.curso_interes || '').includes(filterCourse);
                }

                return matchText && matchDate && matchCourse;
            });

            if (currentView === 'table') renderTable(filtered);
            else renderKanban(filtered);
        };

        function renderTable(leads) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            if (leads.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-400">Sin resultados</td></tr>`;
                return;
            }

            leads.forEach(lead => {
                const isCorp = isCorporate(lead.email);
                let score = 1;
                if (lead.telefono) score++;
                if (lead.mensaje && lead.mensaje.length > 10) score++;
                if (isCorp) score += 2;
                const stars = '‚≠ê'.repeat(Math.min(score, 5));

                // B2B Visuals
                const rowClass = isCorp ? "bg-blue-50/50 dark:bg-blue-900/10 border-l-4 border-blue-500" : "";
                const b2bBadge = isCorp 
                    ? `<span class="bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 text-[10px] px-2 py-0.5 rounded-full font-bold uppercase ml-2 border border-purple-200 dark:border-purple-800"><i class="fa-solid fa-building mr-1"></i>Corp</span>` 
                    : '';

                // Tooltip Mensaje
                const msgTooltip = lead.mensaje ? `
                    <div class="tooltip-container relative inline-block">
                        <i class="fa-solid fa-comment-dots text-brand-500 text-lg cursor-pointer animate-pulse"></i>
                        <div class="custom-tooltip invisible absolute z-50 w-64 p-3 mt-2 -ml-32 left-1/2 text-sm text-white bg-gray-900 rounded-xl shadow-xl opacity-0">
                            ${lead.mensaje}
                            <div class="absolute w-3 h-3 bg-gray-900 transform rotate-45 -top-1 left-1/2 -ml-1.5"></div>
                        </div>
                    </div>` : '<span class="text-gray-300">-</span>';

                const tr = document.createElement('tr');
                tr.className = `hover:bg-gray-100 dark:hover:bg-gray-800/80 border-b border-gray-100 dark:border-gray-700 transition fade-in ${rowClass}`;
                tr.innerHTML = `
                    <td class="p-4 text-xs text-yellow-500" title="Score: ${score}/5">${stars}</td>
                    <td class="p-4">
                        <div class="font-bold text-gray-800 dark:text-gray-100 flex items-center">${lead.nombre} ${b2bBadge}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">${lead.email}</div>
                        <div class="text-xs text-gray-400 font-mono mt-0.5">${formatDate(lead.fecha_creacion)}</div>
                    </td>
                    <td class="p-4">
                         <span class="bg-brand-50 dark:bg-brand-900/20 text-brand-700 dark:text-brand-300 px-2 py-1 rounded text-xs font-semibold border border-brand-100 dark:border-brand-800">${lead.curso_interes}</span>
                    </td>
                    <td class="p-4 text-center cursor-pointer transform hover:scale-105 transition" onclick="window.toggleStatus('${lead.id}', '${lead.status}')">
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${getStatusClass(lead.status)}">
                            ${lead.status.toUpperCase()}
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        ${msgTooltip}
                        ${lead.observaciones ? `<div class="mt-1 text-xs bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200 px-1 rounded inline-block cursor-help" title="${lead.observaciones}"><i class="fa-solid fa-note-sticky mr-1"></i>Nota</div>` : ''}
                    </td>
                    <td class="p-4 text-center flex justify-center gap-2">
                         ${isTrashMode 
                            ? `<button onclick="window.restoreLead('${lead.id}')" class="text-green-500 hover:bg-green-100 p-2 rounded-full" title="Restaurar"><i class="fa-solid fa-trash-arrow-up"></i></button>
                               <button onclick="window.hardDelete('${lead.id}')" class="text-red-600 hover:bg-red-100 p-2 rounded-full" title="Borrar Definitivo"><i class="fa-solid fa-xmark"></i></button>`
                            : `<button onclick="window.openCall('${lead.telefono}')" class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-500 hover:text-white transition flex items-center justify-center" title="Llamar"><i class="fa-solid fa-phone"></i></button>
                               <button onclick="window.openWA('${lead.telefono}','${lead.nombre}','${lead.curso_interes}')" class="w-8 h-8 rounded-full bg-green-50 text-green-600 hover:bg-green-500 hover:text-white transition flex items-center justify-center" title="WhatsApp"><i class="fab fa-whatsapp text-lg"></i></button>
                               <button onclick="window.openEmail('${lead.email}','${lead.nombre}','${lead.curso_interes}')" class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 hover:bg-indigo-500 hover:text-white transition flex items-center justify-center" title="Email"><i class="fa-solid fa-envelope"></i></button>
                               <button onclick="window.editNote('${lead.id}', '${lead.observaciones||''}')" class="w-8 h-8 rounded-full bg-yellow-50 text-yellow-600 hover:bg-yellow-400 hover:text-white transition flex items-center justify-center" title="Notas"><i class="fa-solid fa-pen"></i></button>
                               <button onclick="window.moveToTrash('${lead.id}')" class="w-8 h-8 rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50 transition flex items-center justify-center" title="Papelera"><i class="fa-solid fa-trash"></i></button>`
                          }
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderKanban(leads) {
            const cols = {
                pendiente: document.getElementById('kanban-pending'),
                seguimiento: document.getElementById('kanban-progress'),
                contactado: document.getElementById('kanban-contacted')
            };
            
            // Limpiar columnas
            Object.values(cols).forEach(c => c.innerHTML = '');

            leads.forEach(lead => {
                const col = cols[lead.status] || cols['pendiente'];
                const isCorp = isCorporate(lead.email);
                const corpClass = isCorp ? 'is-corporate-card' : '';
                const corpIcon = isCorp ? '<i class="fa-solid fa-building text-purple-500 text-xs" title="Empresa"></i>' : '';

                const card = document.createElement('div');
                card.className = `bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-600 cursor-grab hover:shadow-md transition fade-in relative group ${corpClass}`;
                card.setAttribute('data-id', lead.id);
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-sm text-gray-800 dark:text-gray-100">${lead.nombre}</h4>
                        ${corpIcon}
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-2 truncate">${lead.email}</p>
                    <div class="flex items-center justify-between mt-3">
                         <span class="text-[10px] bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-gray-500 dark:text-gray-300 truncate max-w-[100px]">${lead.curso_interes}</span>
                         <div class="flex gap-1">
                             <button onclick="window.openCall('${lead.telefono}')" class="text-blue-500 hover:scale-110 transition p-1"><i class="fa-solid fa-phone"></i></button>
                             <button onclick="window.openWA('${lead.telefono}','${lead.nombre}','${lead.curso_interes}')" class="text-green-500 hover:scale-110 transition p-1"><i class="fab fa-whatsapp"></i></button>
                             <button onclick="window.openEmail('${lead.email}','${lead.nombre}','${lead.curso_interes}')" class="text-indigo-500 hover:scale-110 transition p-1"><i class="fa-solid fa-envelope"></i></button>
                         </div>
                    </div>
                `;
                col.appendChild(card);
            });

            // Inicializar Drag & Drop
            Object.values(cols).forEach(el => {
                new Sortable(el, {
                    group: 'kanban',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: async (evt) => {
                        const id = evt.item.getAttribute('data-id');
                        const newStatus = evt.to.getAttribute('data-status');
                        if(id && newStatus) {
                            await updateDoc(doc(db, "leads", id), { status: newStatus });
                        }
                    }
                });
            });
        }

        // 5. GR√ÅFICOS (Chart.js)
        function updateChart(dataArray) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            const labels = Array.from({length: 7}, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                return d.toLocaleDateString('es-CL', {weekday:'short'});
            });

            if (trendChartInstance) trendChartInstance.destroy();

            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nuevos Leads',
                        data: dataArray,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#2563eb'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: {display: false} },
                    scales: {
                        y: { beginAtZero: true, grid: {display:false} },
                        x: { grid: {display:false} }
                    }
                }
            });
        }

        // 6. ACCIONES GLOBALES
        window.switchView = (view) => {
            currentView = view;
            document.getElementById('view-table').classList.toggle('hidden', view !== 'table');
            document.getElementById('view-kanban').classList.toggle('hidden', view !== 'kanban');
            document.getElementById('btn-view-table').className = view === 'table' ? "flex-1 sm:flex-none px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-sm bg-white dark:bg-gray-700 text-brand-600 dark:text-white" : "flex-1 sm:flex-none px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 transition-all";
            document.getElementById('btn-view-kanban').className = view === 'kanban' ? "flex-1 sm:flex-none px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-sm bg-white dark:bg-gray-700 text-brand-600 dark:text-white" : "flex-1 sm:flex-none px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 transition-all";
            renderApp();
        };

        window.toggleTrash = () => {
            isTrashMode = !isTrashMode;
            const btn = document.getElementById('btn-trash');
            btn.classList.toggle('text-red-500', isTrashMode);
            btn.classList.toggle('bg-red-50', isTrashMode);
            renderApp();
            if(isTrashMode) Swal.fire({toast:true, position:'top', icon:'warning', title:'Modo Papelera Activo', showConfirmButton:false, timer:2000});
        };

        window.moveToTrash = async (id) => {
            await updateDoc(doc(db, "leads", id), { status: 'trashed' });
            Swal.fire({toast:true, icon:'success', title:'Movido a papelera', position:'bottom-end', showConfirmButton:false, timer:1500});
        };

        window.restoreLead = async (id) => await updateDoc(doc(db, "leads", id), { status: 'pendiente' });
        
        window.hardDelete = async (id) => {
            const res = await Swal.fire({title:'¬øBorrar definitivamente?', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'});
            if(res.isConfirmed) await deleteDoc(doc(db, "leads", id));
        };

        window.toggleStatus = async (id, current) => {
            const newStatus = current === 'contactado' ? 'pendiente' : 'contactado';
            await updateDoc(doc(db, "leads", id), { status: newStatus });
        };

        window.openCall = (phone) => {
            if (!phone) return Swal.fire('Sin tel√©fono', '', 'info');
            window.location.href = `tel:${phone}`;
        };

        window.openWA = (phone, name, course) => {
             if (!phone) return Swal.fire('Sin tel√©fono', '', 'info');
             const p = phone.replace(/\D/g, '').length === 9 ? '56' + phone.replace(/\D/g, '') : phone.replace(/\D/g, '');
             
             // 1. Elegir Plantilla
             Swal.fire({
                title: 'WhatsApp: Elegir Plantilla',
                input: 'select',
                inputOptions: {
                    'hola': 'üëã Saludo Inicial',
                    'info': 'üìÑ Info del Curso',
                    'seg': '‚è≥ Seguimiento'
                },
                inputPlaceholder: 'Selecciona un mensaje...',
                showCancelButton: true,
                confirmButtonText: 'Siguiente'
             }).then((res) => {
                 if(res.isConfirmed && res.value) {
                     const msgs = {
                         hola: `Hola ${name}, te hablo de ProgramBI. Vi tu inter√©s en el curso de ${course}. ¬øC√≥mo podemos ayudarte?`,
                         info: `Hola ${name}, aqu√≠ te env√≠o el temario detallado del curso de ${course} que solicitaste. Quedo atento a tus dudas.`,
                         seg: `Hola ${name}, ¬øtuviste oportunidad de revisar la info del curso de ${course}? Av√≠same para reservar tu cupo.`
                     };
                     
                     // 2. Editar Mensaje
                     Swal.fire({
                         title: 'Editar Mensaje',
                         input: 'textarea',
                         inputValue: msgs[res.value],
                         showCancelButton: true,
                         confirmButtonText: 'Enviar WhatsApp',
                         confirmButtonColor: '#25D366'
                     }).then((finalRes) => {
                         if(finalRes.isConfirmed) {
                             window.open(`https://wa.me/${p}?text=${encodeURIComponent(finalRes.value)}`, '_blank');
                         }
                     });
                 }
             });
        };

        window.openEmail = (email, name, course) => {
            if (!email) return Swal.fire('Sin email', '', 'info');
            
            Swal.fire({
                title: 'Email: Elegir Plantilla',
                input: 'select',
                inputOptions: {
                    'bienvenida': 'üëã Bienvenida',
                    'temario': 'üìÑ Env√≠o de Temario',
                    'empresa': 'üè¢ Cotizaci√≥n Empresa'
                },
                inputPlaceholder: 'Selecciona asunto...',
                showCancelButton: true,
                confirmButtonText: 'Siguiente'
            }).then((res) => {
                if(res.isConfirmed && res.value) {
                    const templates = {
                        bienvenida: {
                            subject: `Bienvenido a ProgramBI - Curso ${course}`,
                            body: `Hola ${name},\n\nGracias por tu inter√©s en nuestro curso de ${course}. Estamos encantados de ayudarte a potenciar tus habilidades.\n\n¬øTienes alguna duda espec√≠fica?\n\nSaludos,\nEquipo ProgramBI`
                        },
                        temario: {
                            subject: `Informaci√≥n Curso ${course}`,
                            body: `Hola ${name},\n\nAdjunto encontrar√°s la informaci√≥n detallada del curso de ${course}.\n\nNuestras pr√≥ximas fechas son...\n\nQuedo atento.`
                        },
                        empresa: {
                            subject: `Propuesta Capacitaci√≥n - ${course}`,
                            body: `Estimado/a ${name},\n\nGracias por cotizar el curso de ${course} para su equipo.\n\nPodemos ofrecer planes a medida...\n\nSaludos cordiales.`
                        }
                    };

                    const selected = templates[res.value];

                    // Editar Cuerpo
                    Swal.fire({
                         title: 'Editar Cuerpo del Correo',
                         input: 'textarea',
                         inputValue: selected.body,
                         inputLabel: `Asunto: ${selected.subject}`,
                         inputAttributes: { rows: 10 },
                         showCancelButton: true,
                         confirmButtonText: 'Abrir Gestor de Correo',
                         confirmButtonColor: '#3b82f6'
                     }).then((finalRes) => {
                         if(finalRes.isConfirmed) {
                             window.location.href = `mailto:${email}?subject=${encodeURIComponent(selected.subject)}&body=${encodeURIComponent(finalRes.value)}`;
                         }
                     });
                }
            });
        };

        window.editNote = async (id, current) => {
            const {value:text} = await Swal.fire({input:'textarea', inputValue:current, title:'Nota Interna'});
            if(text !== undefined) await updateDoc(doc(db,"leads",id), {observaciones:text});
        };

        // Export Excel
        document.getElementById('export-btn').addEventListener('click', () => {
             let csv = "Fecha,Nombre,Email,Telefono,Curso,Mensaje,Estado,Observaciones\n";
             allLeads.forEach(l => csv += `${formatDate(l.fecha_creacion)},${l.nombre},${l.email},${l.telefono},${l.curso_interes},${(l.mensaje||'').replace(/,/g,' ')},${l.status},${(l.observaciones||'').replace(/,/g,' ')}\n`);
             const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv); a.download='crm_export.csv'; a.click();
        });

        // Modo Oscuro
        const html = document.documentElement;
        document.getElementById('theme-toggle').addEventListener('click', () => {
            html.classList.toggle('dark');
            localStorage.theme = html.classList.contains('dark') ? 'dark' : 'light';
        });
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            html.classList.add('dark');
        }

        // Filtros eventos
        document.getElementById('search-input').addEventListener('keyup', renderApp);
        document.getElementById('filter-date').addEventListener('change', renderApp);
        document.getElementById('filter-course').addEventListener('change', renderApp);

        // Helpers
        function isCorporate(email) { return !['gmail.com','hotmail.com','outlook.com','yahoo.com'].some(d => (email||'').includes(d)); }
        function formatDate(ts) { return ts ? ts.toDate().toLocaleDateString('es-CL') : '--'; }
        
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " a√±os";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " meses";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " d√≠as";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " h";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " min";
            return "Ahora";
        }

        function getStatusClass(s) {
            if(s==='contactado') return 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300';
            if(s==='seguimiento') return 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300';
            if(s==='trashed') return 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300';
            return 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300';
        }

    </script>
</body>
</html>
