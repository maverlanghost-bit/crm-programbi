<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM Director - Ultimate Mobile</title>
    
    <!-- 1. DEPENDENCIAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        glass: "rgba(255, 255, 255, 0.7)",
                        darkGlass: "rgba(17, 24, 39, 0.8)",
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        /* Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass-panel {
            background: rgba(17, 24, 39, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Scrollbar Personalizado */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        /* Animaciones */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Estilos Kanban */
        .kanban-col { min-height: 200px; }
        .sortable-ghost { opacity: 0.4; background: #e2e8f0; border: 2px dashed #94a3b8; }

        /* Tooltip CSS Puro (Desktop) + Fix M贸vil */
        .tooltip-wrap { position: relative; }
        .tooltip-wrap .tooltip-content {
            visibility: hidden;
            width: 280px;
            background-color: #1e293b;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 50;
            bottom: 125%; 
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            font-size: 0.8rem;
            line-height: 1.4;
            pointer-events: none;
        }
        /* Solo mostramos tooltip hover en pantallas que soportan hover (mouse) */
        @media (hover: hover) {
            .tooltip-wrap:hover .tooltip-content {
                visibility: visible;
                opacity: 1;
                transform: translateX(-50%) translateY(-5px);
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 min-h-screen selection:bg-brand-500 selection:text-white pb-20 lg:pb-0">

    <!-- === VISTA 1: LOGIN === -->
    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-[url('https://images.unsplash.com/photo-1497215728101-856f4ea42174?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80')] bg-cover bg-center">
        <div class="absolute inset-0 bg-brand-900/80 backdrop-blur-sm"></div>
        
        <div class="relative glass-panel p-8 rounded-3xl shadow-2xl w-full max-w-md border-t border-white/20 fade-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-tr from-brand-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-brand-500/30 transform -rotate-6">
                    <i class="fa-solid fa-chart-simple text-4xl text-white"></i>
                </div>
                <h2 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-brand-600 to-purple-600 dark:from-brand-400 dark:to-purple-400">CRM Director</h2>
                <p class="text-gray-500 dark:text-gray-400 text-sm mt-2 font-medium">Panel de Control Inteligente</p>
            </div>
            
            <form id="login-form" class="space-y-5">
                <div class="relative">
                    <i class="fa-solid fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="email" id="login-email" class="w-full pl-12 pr-4 py-4 rounded-xl bg-gray-50 dark:bg-gray-800 border-none focus:ring-2 focus:ring-brand-500 transition-all dark:text-white text-lg" value="admin@programbi.com" placeholder="Email" readonly>
                </div>
                <div class="relative">
                    <i class="fa-solid fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="password" id="login-password" class="w-full pl-12 pr-4 py-4 rounded-xl bg-gray-50 dark:bg-gray-800 border-none focus:ring-2 focus:ring-brand-500 transition-all dark:text-white text-lg" value="password" placeholder="Contrase帽a">
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-brand-600 to-purple-600 hover:from-brand-700 hover:to-purple-700 text-white font-bold py-4 rounded-xl shadow-xl shadow-brand-500/20 transform hover:scale-[1.02] transition-all flex justify-center items-center gap-2 text-lg">
                    <span>Entrar al Sistema</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- === VISTA 2: DASHBOARD PRINCIPAL === -->
    <div id="dashboard-view" class="hidden min-h-screen flex flex-col transition-all duration-300">
        
        <!-- Navbar -->
        <nav class="glass-panel sticky top-0 z-40 border-b shadow-sm">
            <div class="max-w-7xl mx-auto px-4 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <div class="bg-brand-600 text-white w-9 h-9 rounded-xl flex items-center justify-center font-bold text-xl shadow-md">D</div>
                            <span class="font-bold text-lg tracking-tight hidden sm:block">Director<span class="text-brand-600 dark:text-brand-400">CRM</span></span>
                        </div>
                        <div class="h-6 w-px bg-gray-300 dark:bg-gray-700 hidden sm:block"></div>
                        <button id="theme-toggle" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition text-gray-600 dark:text-gray-300 active:scale-95">
                            <i class="fa-solid fa-moon dark:hidden text-lg"></i>
                            <i class="fa-solid fa-sun hidden dark:block text-yellow-400 text-lg"></i>
                        </button>
                    </div>

                    <div class="flex items-center gap-3">
                        <div class="text-right hidden sm:block leading-tight">
                            <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Conectado como</p>
                            <p id="user-display" class="text-sm font-bold truncate max-w-[150px]">Admin</p>
                        </div>
                        <button id="logout-btn" class="w-10 h-10 flex items-center justify-center bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-xl hover:bg-red-100 transition shadow-sm active:scale-95">
                            <i class="fa-solid fa-power-off text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-1 max-w-7xl w-full mx-auto p-3 sm:p-6 lg:p-8 space-y-6">
            
            <!-- SECCIN KPIs -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
                <div class="lg:col-span-2 grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4">
                    <div class="glass-panel p-4 rounded-2xl shadow-sm relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-16 h-16 bg-brand-500/10 rounded-bl-full -mr-4 -mt-4"></div>
                        <p class="text-gray-500 dark:text-gray-400 text-[10px] font-bold uppercase tracking-wider">Total Leads</p>
                        <h3 id="kpi-total" class="text-3xl font-bold text-gray-800 dark:text-white mt-1">0</h3>
                    </div>
                    <div class="glass-panel p-4 rounded-2xl shadow-sm border-l-4 border-yellow-400 relative overflow-hidden">
                        <p class="text-gray-500 dark:text-gray-400 text-[10px] font-bold uppercase tracking-wider">Pendientes</p>
                        <h3 id="kpi-pending" class="text-3xl font-bold text-yellow-600 dark:text-yellow-400 mt-1">0</h3>
                    </div>
                    <div class="glass-panel p-4 rounded-2xl shadow-sm border-l-4 border-green-500 relative overflow-hidden">
                        <p class="text-gray-500 dark:text-gray-400 text-[10px] font-bold uppercase tracking-wider">Cerrados</p>
                        <h3 id="kpi-contacted" class="text-3xl font-bold text-green-600 dark:text-green-400 mt-1">0</h3>
                    </div>
                    <button id="export-btn" class="bg-gradient-to-br from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white rounded-2xl p-4 shadow-lg shadow-green-500/20 flex flex-col justify-center items-center gap-1 transition-all active:scale-95 group min-h-[80px]">
                        <i class="fa-solid fa-file-csv text-2xl"></i>
                        <span class="font-bold text-xs">Exportar</span>
                    </button>
                </div>

                <div class="glass-panel p-5 rounded-2xl shadow-sm h-48 lg:h-auto flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-xs text-gray-500 uppercase tracking-wide">Ingresos (7 d铆as)</h4>
                        <span class="text-[10px] bg-green-100 text-green-600 px-2 py-0.5 rounded-full">En vivo</span>
                    </div>
                    <div class="flex-1 relative w-full"><canvas id="trendChart"></canvas></div>
                </div>
            </div>

            <!-- Barra de Control -->
            <div class="flex flex-col lg:flex-row justify-between items-center gap-3 bg-white dark:bg-gray-800 p-3 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                <div class="relative w-full lg:w-auto">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="Buscar cliente..." class="w-full lg:w-72 pl-12 pr-4 py-3.5 rounded-xl bg-gray-50 dark:bg-gray-900 border-none focus:ring-2 focus:ring-brand-500 text-base dark:text-white transition-all shadow-sm">
                </div>
                
                <div class="flex items-center gap-2 bg-gray-100 dark:bg-gray-900 p-1.5 rounded-xl w-full sm:w-auto overflow-x-auto">
                    <button onclick="window.switchView('table')" id="btn-view-table" class="flex-1 sm:flex-none px-6 py-3 rounded-lg text-sm font-bold transition-all bg-white dark:bg-gray-700 text-brand-600 dark:text-white shadow-sm">
                        <i class="fa-solid fa-table mr-2"></i>Tabla
                    </button>
                    <button onclick="window.switchView('kanban')" id="btn-view-kanban" class="flex-1 sm:flex-none px-6 py-3 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-700 dark:text-gray-400 transition-all">
                        <i class="fa-solid fa-border-all mr-2"></i>Kanban
                    </button>
                    <button onclick="window.toggleTrash()" id="btn-trash" class="ml-2 w-11 h-11 flex items-center justify-center rounded-lg text-gray-400 hover:text-red-500 transition active:scale-95 bg-white dark:bg-gray-800 shadow-sm" title="Papelera"><i class="fa-solid fa-trash-can text-lg"></i></button>
                </div>
            </div>

            <!-- Contenedor Vistas -->
            <div class="relative min-h-[400px]">
                
                <!-- VISTA TABLA -->
                <div id="view-table" class="fade-in glass-panel rounded-2xl shadow-sm overflow-hidden flex flex-col">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse min-w-[800px] lg:min-w-0">
                            <thead class="bg-gray-50/50 dark:bg-gray-800/50 text-gray-500 dark:text-gray-400 text-xs uppercase font-bold border-b border-gray-100 dark:border-gray-700">
                                <tr>
                                    <th class="p-4">Lead / Fecha</th>
                                    <th class="p-4">Contacto</th>
                                    <th class="p-4 w-48">Mensaje</th>
                                    <th class="p-4 text-center w-40">Pr贸x. Llamada</th>
                                    <th class="p-4 text-center">Estado</th>
                                    <th class="p-4 text-center">Nota</th>
                                    <th class="p-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="text-sm divide-y divide-gray-100 dark:divide-gray-800">
                                <!-- JS Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- VISTA KANBAN -->
                <div id="view-kanban" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 lg:gap-6 h-full pb-4">
                    <div class="flex flex-col h-full bg-gray-50 dark:bg-gray-800/50 rounded-2xl p-3 border border-gray-200 dark:border-gray-700">
                        <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-3 pb-2 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
                            <span><i class="fa-regular fa-clock text-yellow-500 mr-2"></i>Pendientes</span>
                            <span id="count-kanban-pendiente" class="text-xs font-bold bg-white dark:bg-gray-700 px-2 py-1 rounded-lg shadow-sm">0</span>
                        </h3>
                        <div id="kanban-pendiente" class="kanban-col flex-1 space-y-3" data-status="pendiente"></div>
                    </div>
                    <div class="flex flex-col h-full bg-gray-50 dark:bg-gray-800/50 rounded-2xl p-3 border border-gray-200 dark:border-gray-700">
                        <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-3 pb-2 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
                            <span><i class="fa-solid fa-spinner text-blue-500 mr-2"></i>Seguimiento</span>
                            <span id="count-kanban-seguimiento" class="text-xs font-bold bg-white dark:bg-gray-700 px-2 py-1 rounded-lg shadow-sm">0</span>
                        </h3>
                        <div id="kanban-seguimiento" class="kanban-col flex-1 space-y-3" data-status="seguimiento"></div>
                    </div>
                    <div class="flex flex-col h-full bg-gray-50 dark:bg-gray-800/50 rounded-2xl p-3 border border-gray-200 dark:border-gray-700">
                        <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-3 pb-2 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
                            <span><i class="fa-solid fa-check-circle text-green-500 mr-2"></i>Cerrados</span>
                            <span id="count-kanban-contactado" class="text-xs font-bold bg-white dark:bg-gray-700 px-2 py-1 rounded-lg shadow-sm">0</span>
                        </h3>
                        <div id="kanban-contactado" class="kanban-col flex-1 space-y-3" data-status="contactado"></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- === LGICA DEL SISTEMA (JS) === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVlTFLAX1Ya28uoqQ-mqTFFakHxQ3GgVI",
            authDomain: "crm-programbi-9934a.firebaseapp.com",
            projectId: "crm-programbi-9934a",
            storageBucket: "crm-programbi-9934a.firebasestorage.app",
            messagingSenderId: "646856396244",
            appId: "1:646856396244:web:6caacd7c27b644f087da41"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch(e) { console.error("Firebase Init Error:", e); }

        let allLeads = [];
        let isTrashMode = false;
        let currentView = 'table';
        let trendChartInstance = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
                initDataListener();
            } else {
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById('login-view').classList.remove('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Conectando...';
            try { await signInAnonymously(auth); } 
            catch (err) {
                Swal.fire({icon:'error', title:'Error de Conexi贸n', text: err.message});
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        function initDataListener() {
            const q = query(collection(db, "leads"), orderBy("fecha", "desc")); 
            
            onSnapshot(q, (snapshot) => {
                allLeads = [];
                const last7Days = Array(7).fill(0);
                
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const lead = { 
                        id: docSnap.id, 
                        nombre: data.nombre || 'Sin Nombre',
                        email: data.email || '',
                        telefono: data.telefono || '', 
                        curso_interes: Array.isArray(data.intereses) ? data.intereses.join(", ") : (data.intereses || 'General'),
                        status: data.status || 'pendiente',
                        fecha: data.fecha || data.fecha_creacion,
                        observaciones: data.observaciones || '',
                        mensaje: data.mensaje || '', 
                        proxima_llamada: data.proxima_llamada
                    };
                    allLeads.push(lead);

                    if (lead.fecha) {
                        try {
                            const date = lead.fecha.toDate();
                            const diffDays = Math.floor((new Date() - date) / (1000 * 60 * 60 * 24));
                            if (diffDays < 7 && diffDays >= 0) last7Days[6 - diffDays]++;
                        } catch(e) {}
                    }
                });
                updateKPIs();
                updateChart(last7Days);
                renderApp();
            });
        }

        window.switchView = (view) => {
            currentView = view;
            document.getElementById('view-table').classList.toggle('hidden', view !== 'table');
            document.getElementById('view-kanban').classList.toggle('hidden', view !== 'kanban');
            const btnTable = document.getElementById('btn-view-table');
            const btnKanban = document.getElementById('btn-view-kanban');
            // Botones m谩s grandes y claros
            if (view === 'table') {
                btnTable.className = "flex-1 sm:flex-none px-6 py-3 rounded-lg text-sm font-bold transition-all bg-white dark:bg-gray-700 text-brand-600 dark:text-white shadow-sm ring-1 ring-brand-200 dark:ring-gray-600 transform scale-105";
                btnKanban.className = "flex-1 sm:flex-none px-6 py-3 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-700 dark:text-gray-400 transition-all";
            } else {
                btnTable.className = "flex-1 sm:flex-none px-6 py-3 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-700 dark:text-gray-400 transition-all";
                btnKanban.className = "flex-1 sm:flex-none px-6 py-3 rounded-lg text-sm font-bold transition-all bg-white dark:bg-gray-700 text-brand-600 dark:text-white shadow-sm ring-1 ring-brand-200 dark:ring-gray-600 transform scale-105";
            }
            renderApp();
        };

        window.toggleTrash = () => {
            isTrashMode = !isTrashMode;
            const btn = document.getElementById('btn-trash');
            btn.classList.toggle('text-red-500', isTrashMode);
            btn.classList.toggle('bg-red-50', isTrashMode);
            btn.classList.toggle('ring-2', isTrashMode);
            btn.classList.toggle('ring-red-200', isTrashMode);
            renderApp();
        };

        window.toggleStatus = async (id, current) => {
            const flow = { 'pendiente': 'seguimiento', 'seguimiento': 'contactado', 'contactado': 'pendiente' };
            await updateDoc(doc(db, "leads", id), { status: flow[current] || 'pendiente' });
        };

        window.scheduleCall = async (id, currentVal) => {
            let defaultDate = '';
            if(currentVal) {
                 const d = new Date(currentVal.seconds * 1000);
                 d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                 defaultDate = d.toISOString().slice(0, 16);
            }

            const { value: dateStr } = await Swal.fire({
                title: ' Agendar Llamada',
                html: `<input type="datetime-local" id="swal-date" class="swal2-input w-full p-3 text-lg" value="${defaultDate}">`,
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar',
                customClass: { popup: 'rounded-2xl' }, // Mejora visual en m贸vil
                preConfirm: () => {
                    return document.getElementById('swal-date').value;
                }
            });

            if (dateStr) {
                const newDate = new Date(dateStr);
                await updateDoc(doc(db, "leads", id), { 
                    proxima_llamada: Timestamp.fromDate(newDate),
                    status: 'seguimiento'
                });
                Swal.fire({toast:true, icon:'success', title:'Agenda actualizada', position:'top-end', timer:2000, showConfirmButton:false});
            }
        };

        window.editNote = async (id, current) => {
            const {value:text} = await Swal.fire({
                input: 'textarea', 
                inputValue: current, 
                title: 'Nota Interna',
                placeholder: 'Escribe notas privadas...',
                customClass: { input: 'h-32 text-lg' }
            });
            if(text !== undefined) await updateDoc(doc(db,"leads",id), {observaciones:text});
        };
        
        // Helper para mostrar mensajes completos en m贸vil al tocar
        window.showFullMessage = (text) => {
             Swal.fire({
                 title: 'Mensaje del Cliente',
                 text: text,
                 confirmButtonText: 'Cerrar',
                 customClass: { popup: 'rounded-2xl' }
             });
        };

        window.openEmail = (email, name, course) => {
            if (!email) return Swal.fire('Sin email', '', 'info');
            Swal.fire({
                title: 'Email: Elegir Plantilla',
                input: 'select',
                inputOptions: { 'bienvenida': ' Bienvenida', 'temario': ' Env铆o de Temario', 'empresa': ' Cotizaci贸n Empresa' },
                inputPlaceholder: 'Selecciona asunto...',
                showCancelButton: true,
                confirmButtonText: 'Siguiente',
                customClass: { input: 'h-12 text-lg' }
            }).then((res) => {
                if(res.isConfirmed && res.value) {
                    const templates = {
                        bienvenida: { subject: `Bienvenido a ProgramBI - Curso ${course}`, body: `Hola ${name},\n\nGracias por tu inter茅s en ${course}.` },
                        temario: { subject: `Informaci贸n Curso ${course}`, body: `Hola ${name},\n\nAdjunto informaci贸n del curso.` },
                        empresa: { subject: `Propuesta - ${course}`, body: `Estimado/a ${name},\n\nGracias por cotizar.` }
                    };
                    const sel = templates[res.value];
                    window.location.href = `mailto:${email}?subject=${encodeURIComponent(sel.subject)}&body=${encodeURIComponent(sel.body)}`;
                }
            });
        };

        window.moveToTrash = async (id) => {
            await updateDoc(doc(db, "leads", id), { status: 'trashed' });
            Swal.fire({toast:true, icon:'success', title:'Movido a papelera', position:'bottom-end', showConfirmButton:false, timer:1000});
        };
        
        window.restoreLead = async (id) => {
            await updateDoc(doc(db, "leads", id), { status: 'pendiente' });
            Swal.fire({toast:true, icon:'success', title:'Restaurado', position:'bottom-end', showConfirmButton:false, timer:1000});
        };
        
        window.hardDelete = async (id) => {
            if((await Swal.fire({title:'驴Eliminar definitivamente?', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33', confirmButtonText: 'Borrar', cancelButtonText: 'Cancelar'})).isConfirmed) {
                await deleteDoc(doc(db, "leads", id));
            }
        };

        window.openWA = (phone, name) => {
            if(!phone) return Swal.fire({toast:true, icon:'info', title:'Sin tel茅fono'});
            let clean = phone.replace(/\D/g, '');
            if(clean.length === 9) clean = '56' + clean; 
            window.open(`https://wa.me/${clean}?text=${encodeURIComponent(`Hola ${name}, te contacto de ProgramBI.`)}`, '_blank');
        };

        document.getElementById('export-btn').addEventListener('click', () => {
             let csv = "Fecha,Nombre,Email,Telefono,Curso,Estado,Pr贸xima Llamada,Mensaje Cliente,Notas Internas\n";
             allLeads.forEach(l => {
                 const date = l.fecha && l.fecha.toDate ? l.fecha.toDate().toLocaleDateString() : '--';
                 const nextCall = l.proxima_llamada && l.proxima_llamada.toDate ? l.proxima_llamada.toDate().toLocaleString() : '';
                 const msg = (l.mensaje || '').replace(/(\r\n|\n|\r)/gm, " ");
                 const obs = (l.observaciones || '').replace(/(\r\n|\n|\r)/gm, " ");
                 csv += `${date},${l.nombre},${l.email},${l.telefono},"${l.curso_interes}",${l.status},"${nextCall}","${msg}","${obs}"\n`;
             });
             const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
             const link = document.createElement("a");
             link.href = URL.createObjectURL(blob);
             link.download = "leads_programbi.csv";
             link.click();
        });

        window.renderApp = () => {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = allLeads.filter(l => {
                if (isTrashMode && l.status !== 'trashed') return false;
                if (!isTrashMode && l.status === 'trashed') return false;
                return (l.nombre.toLowerCase().includes(term) || l.email.toLowerCase().includes(term));
            });
            if(currentView === 'table') renderTable(filtered);
            else renderKanban(filtered);
        };

        function renderTable(leads) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            if(leads.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="p-8 text-center text-gray-400">No se encontraron leads</td></tr>`;
                return;
            }

            leads.forEach(lead => {
                const dateStr = lead.fecha && lead.fecha.toDate ? lead.fecha.toDate().toLocaleDateString('es-CL', {day:'2-digit', month:'short'}) : '--';
                
                // Bot贸n de notas (M谩s Grande: w-11 h-11)
                const noteBtnClass = lead.observaciones ? "text-yellow-600 bg-yellow-100 ring-1 ring-yellow-200" : "text-gray-400 bg-gray-100 hover:bg-gray-200";
                
                // Formato Pr贸xima Llamada (Bot贸n grande)
                let nextCallHTML = `<span class="text-gray-400 text-xs italic">--</span>`;
                let nextCallVal = null;
                if(lead.proxima_llamada && lead.proxima_llamada.toDate) {
                    const d = lead.proxima_llamada.toDate();
                    nextCallVal = lead.proxima_llamada; 
                    const isToday = new Date().toDateString() === d.toDateString();
                    const colorClass = isToday ? "text-red-600 bg-red-50 border-red-100 animate-pulse font-bold" : "text-brand-600 bg-brand-50 border-brand-100";
                    nextCallHTML = `<div class="${colorClass} px-3 py-2 rounded-lg border flex flex-col items-center justify-center min-w-[100px]"><span class="text-xs uppercase font-bold text-gray-400 mb-0.5">${d.getDate()}/${d.getMonth()+1}</span><span class="text-sm font-bold">${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}</span></div>`;
                } else {
                    nextCallHTML = `<div class="w-10 h-10 rounded-lg bg-gray-50 flex items-center justify-center text-gray-300 hover:text-brand-500 transition"><i class="fa-regular fa-calendar-plus text-lg"></i></div>`;
                }

                // Mensaje (L贸gica H铆brida Desktop/Mobile)
                const hasMessage = lead.mensaje && lead.mensaje.length > 0;
                // En m贸vil, agregamos onclick para mostrar el mensaje completo
                const msgClickAction = hasMessage ? `onclick="window.showFullMessage('${lead.mensaje.replace(/'/g, "\\'")}')"` : '';
                const messagePreview = hasMessage ? lead.mensaje : '<span class="text-gray-300 italic">Sin mensaje</span>';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 dark:hover:bg-gray-800 transition border-b border-gray-100 dark:border-gray-700 group";
                
                tr.innerHTML = `
                    <td class="p-4">
                        <div class="font-bold text-base text-gray-800 dark:text-gray-100 mb-1">${lead.nombre}</div>
                        <div class="text-xs text-gray-400 font-mono bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded w-max">${dateStr}</div>
                    </td>
                    <td class="p-4 text-sm">
                        <div class="flex flex-col gap-2">
                            <div class="text-gray-600 dark:text-gray-300 flex items-center gap-3 cursor-pointer hover:text-brand-500 p-1" onclick="navigator.clipboard.writeText('${lead.email}')" title="Copiar Email">
                                <i class="fa-solid fa-envelope text-gray-400"></i>${lead.email}
                            </div>
                            ${lead.telefono ? `<div class="text-gray-600 dark:text-gray-300 flex items-center gap-3 p-1"><i class="fa-solid fa-phone text-gray-400"></i>${lead.telefono}</div>` : ''}
                        </div>
                    </td>
                    
                    <!-- COLUMNA MENSAJE (Tooltip + OnClick Mobile) -->
                    <td class="p-4 tooltip-wrap" ${msgClickAction}>
                        <div class="truncate w-40 text-sm text-gray-600 dark:text-gray-400 cursor-pointer border-l-4 border-transparent hover:border-brand-300 pl-3 transition-all">
                            ${messagePreview}
                        </div>
                        ${hasMessage ? `<div class="tooltip-content shadow-xl">${lead.mensaje}</div>` : ''}
                    </td>

                    <!-- COLUMNA PRXIMA LLAMADA -->
                    <td class="p-4 text-center">
                        <button onclick="window.scheduleCall('${lead.id}', ${nextCallVal ? JSON.stringify(nextCallVal).replace(/"/g, "'") : 'null'})" class="hover:bg-gray-100 dark:hover:bg-gray-700 p-1 rounded-xl transition border border-transparent hover:border-gray-200">
                            ${nextCallHTML}
                        </button>
                    </td>

                    <td class="p-4 text-center cursor-pointer select-none" onclick="window.toggleStatus('${lead.id}', '${lead.status}')">
                        <span class="px-4 py-2 rounded-lg text-xs font-extrabold uppercase tracking-wide transition transform hover:scale-105 inline-block shadow-sm ${getStatusColor(lead.status)}">
                            ${lead.status}
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="window.editNote('${lead.id}', '${(lead.observaciones||'').replace(/'/g, "\\'")}')" class="${noteBtnClass} w-11 h-11 flex items-center justify-center rounded-xl transition shadow-sm active:scale-95 mx-auto" title="Notas Internas">
                            <i class="fa-solid fa-note-sticky text-lg"></i>
                        </button>
                    </td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center gap-3">
                            ${!isTrashMode ? `
                                <button onclick="window.openEmail('${lead.email}', '${lead.nombre}', '${lead.curso_interes}')" class="w-11 h-11 rounded-xl bg-indigo-50 text-indigo-600 hover:bg-indigo-500 hover:text-white transition flex items-center justify-center shadow-sm active:scale-95" title="Email"><i class="fa-solid fa-envelope text-lg"></i></button>
                                <button onclick="window.openWA('${lead.telefono}', '${lead.nombre}')" class="w-11 h-11 rounded-xl bg-green-50 text-green-600 hover:bg-green-500 hover:text-white transition flex items-center justify-center shadow-sm active:scale-95" title="WhatsApp"><i class="fab fa-whatsapp text-xl"></i></button>
                                <button onclick="window.moveToTrash('${lead.id}')" class="w-11 h-11 rounded-xl bg-gray-50 text-gray-400 hover:bg-red-50 hover:text-red-500 transition flex items-center justify-center shadow-sm active:scale-95" title="Borrar"><i class="fa-solid fa-trash text-lg"></i></button>
                            ` : `
                                <button onclick="window.restoreLead('${lead.id}')" class="w-11 h-11 rounded-xl bg-green-50 text-green-500 flex items-center justify-center shadow-sm" title="Restaurar"><i class="fa-solid fa-trash-arrow-up text-lg"></i></button>
                                <button onclick="window.hardDelete('${lead.id}')" class="w-11 h-11 rounded-xl bg-red-50 text-red-600 flex items-center justify-center shadow-sm" title="Eliminar"><i class="fa-solid fa-xmark text-xl"></i></button>
                            `}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderKanban(leads) {
            const cols = { pendiente: document.getElementById('kanban-pendiente'), seguimiento: document.getElementById('kanban-seguimiento'), contactado: document.getElementById('kanban-contactado') };
            Object.keys(cols).forEach(key => {
                cols[key].innerHTML = '';
                document.getElementById(`count-kanban-${key}`).textContent = leads.filter(l => l.status === key).length;
            });
            leads.forEach(lead => {
                const col = cols[lead.status] || cols['pendiente'];
                const card = document.createElement('div');
                card.className = "bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-600 cursor-grab active:cursor-grabbing hover:shadow-md transition mb-3 relative group";
                card.setAttribute('data-id', lead.id);
                
                let callBadge = '';
                if(lead.proxima_llamada && lead.proxima_llamada.toDate) {
                    const d = lead.proxima_llamada.toDate();
                    callBadge = `<div class="mt-3 text-xs bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 px-3 py-1.5 rounded-lg inline-flex items-center font-bold w-full justify-center"><i class="fa-regular fa-clock mr-2"></i> ${d.getDate()}/${d.getMonth()+1} - ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}</div>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-base text-gray-800 dark:text-gray-100 line-clamp-1">${lead.nombre}</h4>
                        <span class="text-[10px] text-gray-400 bg-gray-50 dark:bg-gray-700 px-2 py-1 rounded-md font-mono">${lead.fecha && lead.fecha.toDate ? lead.fecha.toDate().getDate() + '/' + (lead.fecha.toDate().getMonth()+1) : ''}</span>
                    </div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-3 truncate font-medium text-brand-600 dark:text-brand-400">${lead.curso_interes}</div>
                    ${callBadge}
                    <div class="flex justify-between items-center border-t border-gray-100 dark:border-gray-700 pt-3 mt-3">
                        <button onclick="window.openEmail('${lead.email}', '${lead.nombre}', '${lead.curso_interes}')" class="text-indigo-500 bg-indigo-50 hover:bg-indigo-100 w-10 h-10 flex items-center justify-center rounded-xl transition"><i class="fa-solid fa-envelope"></i></button>
                        <div class="flex gap-2">
                            <button onclick="window.scheduleCall('${lead.id}')" class="text-gray-500 bg-gray-100 hover:bg-gray-200 w-10 h-10 flex items-center justify-center rounded-xl transition"><i class="fa-regular fa-calendar-plus"></i></button>
                            <button onclick="window.openWA('${lead.telefono}', '${lead.nombre}')" class="text-green-600 bg-green-50 hover:bg-green-100 w-10 h-10 flex items-center justify-center rounded-xl transition"><i class="fab fa-whatsapp text-lg"></i></button>
                        </div>
                    </div>
                `;
                col.appendChild(card);
            });
            Object.values(cols).forEach(el => new Sortable(el, { group: 'kanban', animation: 150, ghostClass: 'sortable-ghost', onEnd: async (evt) => {
                const id = evt.item.getAttribute('data-id');
                const status = evt.to.getAttribute('data-status');
                if(id && status) await updateDoc(doc(db, "leads", id), { status });
            }}));
        }

        function getStatusColor(s) {
            if(s==='contactado') return 'bg-green-100 text-green-700 border border-green-200';
            if(s==='seguimiento') return 'bg-blue-100 text-blue-700 border border-blue-200';
            return 'bg-yellow-100 text-yellow-700 border border-yellow-200';
        }

        function updateKPIs() {
            const active = allLeads.filter(l => l.status !== 'trashed');
            document.getElementById('kpi-total').textContent = active.length;
            document.getElementById('kpi-pending').textContent = active.filter(l => l.status === 'pendiente').length;
            document.getElementById('kpi-contacted').textContent = active.filter(l => l.status === 'contactado').length;
        }

        function updateChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if(trendChartInstance) trendChartInstance.destroy();
            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Hace 6d','Hace 5d','Hace 4d','Hace 3d','Anteayer','Ayer','Hoy'],
                    datasets: [{ 
                        data, borderColor: '#3b82f6', borderWidth: 3, pointBackgroundColor: '#fff', pointBorderColor: '#3b82f6', pointRadius: 4, tension: 0.4, fill: true, 
                        backgroundColor: (c) => {
                            const grad = c.chart.ctx.createLinearGradient(0, 0, 0, 200);
                            grad.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
                            grad.addColorStop(1, 'rgba(59, 130, 246, 0)');
                            return grad;
                        }
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: {legend:{display:false}, tooltip:{mode:'index', intersect:false}}, scales:{x:{display:false}, y:{display:false}} }
            });
        }

        document.getElementById('search-input').addEventListener('keyup', renderApp);
        document.getElementById('theme-toggle').addEventListener('click', () => document.documentElement.classList.toggle('dark'));
    </script>
</body>
</html>
